============================= test session starts ==============================
platform darwin -- Python 3.13.3, pytest-8.3.5, pluggy-1.5.0 -- /Library/Frameworks/Python.framework/Versions/3.13/bin/python3.13
cachedir: .pytest_cache
rootdir: /Users/alexmunroe/Development/Gemini-Renamer
configfile: pyproject.toml
plugins: mock-3.14.0, cov-6.1.1
collecting ... collected 130 items

tests/test_cli.py::test_parse_arguments_minimal PASSED                   [  0%]
tests/test_cli.py::test_parse_arguments_with_flags PASSED                [  1%]
tests/test_cli.py::test_parse_arguments_undo_command PASSED              [  2%]
tests/test_cli.py::test_parse_arguments_missing_command PASSED           [  3%]
tests/test_cli.py::test_help_message PASSED                              [  3%]
tests/test_file_system_ops.py::test_perform_file_actions_dry_run_rename PASSED [  4%]
tests/test_file_system_ops.py::test_perform_file_actions_dry_run_move_create_dir PASSED [  5%]
tests/test_file_system_ops.py::test_perform_file_actions_live_rename PASSED [  6%]
tests/test_file_system_ops.py::test_perform_file_actions_live_move_create_dir PASSED [  6%]
tests/test_file_system_ops.py::test_perform_file_actions_live_trash PASSED [  7%]
tests/test_file_system_ops.py::test_perform_file_actions_live_backup PASSED [  8%]
tests/test_file_system_ops.py::test_perform_file_actions_live_stage PASSED [  9%]
tests/test_file_system_ops.py::test_perform_file_actions_conflict_skip PASSED [ 10%]
tests/test_file_system_ops.py::test_perform_file_actions_conflict_fail PASSED [ 10%]
tests/test_file_system_ops.py::test_perform_file_actions_conflict_overwrite PASSED [ 11%]
tests/test_file_system_ops.py::test_perform_file_actions_conflict_suffix PASSED [ 12%]
tests/test_renamer.py::test_plan_rename_simple_series_no_folders <- ../Gemini_Renamer/tests/test_renamer.py PASSED [ 13%]
tests/test_renamer.py::test_plan_rename_movie_with_folders <- ../Gemini_Renamer/tests/test_renamer.py PASSED [ 13%]
tests/test_renamer.py::test_plan_rename_multi_episode_series_folders <- ../Gemini_Renamer/tests/test_renamer.py PASSED [ 14%]
tests/test_renamer.py::test_plan_rename_no_change <- ../Gemini_Renamer/tests/test_renamer.py PASSED [ 15%]
tests/test_renamer.py::test_plan_rename_conflict_skip <- ../Gemini_Renamer/tests/test_renamer.py PASSED [ 16%]
tests/test_renamer.py::test_plan_rename_conflict_fail <- ../Gemini_Renamer/tests/test_renamer.py PASSED [ 16%]
tests/test_renamer.py::test_plan_rename_conflict_overwrite_suffix <- ../Gemini_Renamer/tests/test_renamer.py PASSED [ 17%]
tests/test_renamer.py::test_plan_rename_include_scene_tags <- ../Gemini_Renamer/tests/test_renamer.py PASSED [ 18%]
tests/test_undo_manager.py::test_init_unexpected_error PASSED            [ 19%]
tests/test_undo_manager.py::test_connect_sqlite_error PASSED             [ 20%]
tests/test_undo_manager.py::test_perform_undo_pending_final_rename_oserror PASSED [ 20%]
tests/test_undo_manager.py::test_perform_undo_pending_final_rename_exception PASSED [ 21%]
tests/test_undo_manager.py::test_perform_undo_created_dir_main_exception FAILED [ 22%]
tests/test_undo_manager.py::test_resolve_db_path_from_config PASSED      [ 23%]
tests/test_undo_manager.py::test_resolve_db_path_config_error PASSED     [ 23%]
tests/test_undo_manager.py::test_resolve_db_path_default_error PASSED    [ 24%]
tests/test_undo_manager.py::test_connect_db_path_none PASSED             [ 25%]
tests/test_undo_manager.py::test_connect_pragma_warning PASSED           [ 26%]
tests/test_undo_manager.py::test_init_db_schema_error_disables_manager PASSED [ 26%]
tests/test_undo_manager.py::test_init_db_creates_table_and_index PASSED  [ 27%]
tests/test_undo_manager.py::test_log_action_skips_stats_for_dir PASSED   [ 28%]
tests/test_undo_manager.py::test_log_action_skips_stats_for_wrong_status PASSED [ 29%]
tests/test_undo_manager.py::test_log_action_stat_target_not_file PASSED  [ 30%]
tests/test_undo_manager.py::test_log_action_integrity_error PASSED       [ 30%]
tests/test_undo_manager.py::test_log_action_stat_os_error PASSED         [ 31%]
tests/test_undo_manager.py::test_log_action_generic_db_error PASSED      [ 32%]
tests/test_undo_manager.py::test_log_action_generic_exception PASSED     [ 33%]
tests/test_undo_manager.py::test_update_action_status_success PASSED     [ 33%]
tests/test_undo_manager.py::test_update_action_status_failure PASSED     [ 34%]
tests/test_undo_manager.py::test_update_action_status_db_error PASSED    [ 35%]
tests/test_undo_manager.py::test_update_action_status_exception PASSED   [ 36%]
tests/test_undo_manager.py::test_prune_skip_negative_days PASSED         [ 36%]
tests/test_undo_manager.py::test_prune_invalid_days_config PASSED        [ 37%]
tests/test_undo_manager.py::test_prune_db_error PASSED                   [ 38%]
tests/test_undo_manager.py::test_prune_exception PASSED                  [ 39%]
tests/test_undo_manager.py::test_prune_no_entries_deleted PASSED         [ 40%]
tests/test_undo_manager.py::test_prune_expired_batches PASSED            [ 40%]
tests/test_undo_manager.py::test_find_temp_file_os_error PASSED          [ 41%]
tests/test_undo_manager.py::test_find_temp_file_multiple_matches PASSED  [ 42%]
tests/test_undo_manager.py::test_check_file_integrity_stat_os_error PASSED [ 43%]
tests/test_undo_manager.py::test_check_file_integrity_stat_exception PASSED [ 43%]
tests/test_undo_manager.py::test_check_file_integrity_no_stats PASSED    [ 44%]
tests/test_undo_manager.py::test_init_db_connect_error PASSED            [ 45%]
tests/test_undo_manager.py::test_perform_undo_failed_status_update_pending_final PASSED [ 46%]
tests/test_undo_manager.py::test_perform_undo_failed_status_update_created_dir PASSED [ 46%]
tests/test_undo_manager.py::test_perform_undo_created_dir_iterdir_oserror PASSED [ 47%]
tests/test_undo_manager.py::test_perform_undo_main_loop_exception PASSED [ 48%]
tests/test_undo_manager.py::test_perform_undo_disabled PASSED            [ 49%]
tests/test_undo_manager.py::test_perform_undo_db_not_found PASSED        [ 50%]
tests/test_undo_manager.py::test_perform_undo_db_fetch_error PASSED      [ 50%]
tests/test_undo_manager.py::test_perform_undo_preview_unknown_status PASSED [ 51%]
tests/test_undo_manager.py::test_perform_undo_confirmation_eof PASSED    [ 52%]
tests/test_undo_manager.py::test_perform_undo_confirmation_exception PASSED [ 53%]
tests/test_undo_manager.py::test_perform_undo_failed_status_update PASSED [ 53%]
tests/test_undo_manager.py::test_perform_undo_revert_os_error PASSED     [ 54%]
tests/test_undo_manager.py::test_perform_undo_revert_exception PASSED    [ 55%]
tests/test_undo_manager.py::test_perform_undo_dir_removal_os_error PASSED [ 56%]
tests/test_undo_manager.py::test_perform_undo_dir_does_not_exist_on_cleanup PASSED [ 56%]
tests/test_undo_manager.py::test_perform_undo_dir_cleanup_exception PASSED [ 57%]
tests/test_undo_manager.py::test_connect_success PASSED                  [ 58%]
tests/test_undo_manager.py::test_log_action_success PASSED               [ 59%]
tests/test_undo_manager.py::test_log_action_stores_stats PASSED          [ 60%]
tests/test_undo_manager.py::test_record_and_undo_move PASSED             [ 60%]
tests/test_undo_manager.py::test_record_and_undo_move_into_created_dir PASSED [ 61%]
tests/test_undo_manager.py::test_batch_undo_multiple_actions PASSED      [ 62%]
tests/test_undo_manager.py::test_undo_with_missing_current_file PASSED   [ 63%]
tests/test_undo_manager.py::test_undo_does_not_crash_with_empty_log PASSED [ 63%]
tests/test_undo_manager.py::test_undo_target_already_exists PASSED       [ 64%]
tests/test_undo_manager.py::test_undo_created_dir_empty PASSED           [ 65%]
tests/test_undo_manager.py::test_undo_created_dir_not_empty PASSED       [ 66%]
tests/test_undo_manager.py::test_undo_integrity_check_success PASSED     [ 66%]
tests/test_undo_manager.py::test_undo_integrity_check_fail_size PASSED   [ 67%]
tests/test_undo_manager.py::test_undo_integrity_check_fail_mtime PASSED  [ 68%]
tests/test_undo_manager.py::test_undo_failed_transaction_temp_file PASSED [ 69%]
tests/test_utils.py::test_sanitize_filename[Valid Filename.mkv-Valid_Filename.mkv] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 70%]
tests/test_utils.py::test_sanitize_filename[File with<>:"/\\|?*chars.mp4-File_with_chars.mp4] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 70%]
tests/test_utils.py::test_sanitize_filename[  Leading and trailing spaces . .txt-Leading_and_trailing_spaces_._.txt] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 71%]
tests/test_utils.py::test_sanitize_filename[  Ends with spaces and dots . . -Ends_with_spaces_and_dots] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 72%]
tests/test_utils.py::test_sanitize_filename[Multiple___Underscores___.srt-Multiple_Underscores_.srt] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 73%]
tests/test_utils.py::test_sanitize_filename[.HiddenFile-.HiddenFile] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 73%]
tests/test_utils.py::test_sanitize_filename[-_invalid_name_] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 74%]
tests/test_utils.py::test_sanitize_filename[<>:"/\\|?*-_invalid_underscores_] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 75%]
tests/test_utils.py::test_sanitize_filename[...-_invalid_dots_] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 76%]
tests/test_utils.py::test_sanitize_filename[ . . . -_invalid_name_] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 76%]
tests/test_utils.py::test_sanitize_filename[___-_invalid_underscores_] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 77%]
tests/test_utils.py::test_extract_scene_tags[My.Show.S01E01.PROPER.mkv-tags_tuple0-expected_list0-.PROPER] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 78%]
tests/test_utils.py::test_extract_scene_tags[Movie.Title.2023.REPACK.1080p.mkv-tags_tuple1-expected_list1-.REPACK] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 79%]
tests/test_utils.py::test_extract_scene_tags[Another.S02E03.REAL.PROPER.mkv-tags_tuple2-expected_list2-.PROPER.REAL] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 80%]
tests/test_utils.py::test_extract_scene_tags[Show.S03E04.mkv-tags_tuple3-expected_list3-] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 80%]
tests/test_utils.py::test_extract_scene_tags[File.With.internal.Source.mkv-tags_tuple4-expected_list4-.INTERNAL] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 81%]
tests/test_utils.py::test_extract_scene_tags[No Tags Here-tags_tuple5-expected_list5-] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 82%]
tests/test_utils.py::test_extract_scene_tags[File.DC.LIMITED.mkv-tags_tuple6-expected_list6-.LIMITED.DC] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 83%]
tests/test_utils.py::test_extract_scene_tags[[Grp] Show.S01E01 (UNCUT) [1080p].mkv-tags_tuple7-expected_list7-.UNCUT] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 83%]
tests/test_utils.py::test_extract_scene_tags[Show.S01E01.CustomTag.mkv-tags_tuple8-expected_list8-] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 84%]
tests/test_utils.py::test_extract_scene_tags[File.proper.mkv-tags_tuple9-expected_list9-.PROPER] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 85%]
tests/test_utils.py::test_extract_scene_tags[File.ends.with.REAL-tags_tuple10-expected_list10-.REAL] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 86%]
tests/test_utils.py::test_extract_scene_tags[LIMITED.file.starts.with.it.mkv-tags_tuple11-expected_list11-.LIMITED] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 86%]
tests/test_utils.py::test_extract_scene_tags[Two.Tags.LIMITED.REPACK.File.mkv-tags_tuple12-expected_list12-.REPACK.LIMITED] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 87%]
tests/test_utils.py::test_parse_subtitle_language[sub.eng.srt-eng-expected_flags0] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 88%]
tests/test_utils.py::test_parse_subtitle_language[sub.en.srt-eng-expected_flags1] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 89%]
tests/test_utils.py::test_parse_subtitle_language[subtitle.fre.forced.sub-fra-expected_flags2] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 90%]
tests/test_utils.py::test_parse_subtitle_language[mysub.spa.sdh.cc.vtt-spa-expected_flags3] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 90%]
tests/test_utils.py::test_parse_subtitle_language[NoLang.srt-None-expected_flags4] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 91%]
tests/test_utils.py::test_parse_subtitle_language[Foreign.Name.German.Forced.srt-deu-expected_flags5] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 92%]
tests/test_utils.py::test_parse_subtitle_language[Weird.Separator-jpn_sdh.ass-jpn-expected_flags6] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 93%]
tests/test_utils.py::test_parse_subtitle_language[Movie.Title.pt-BR.srt-por-expected_flags7] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 93%]
tests/test_utils.py::test_parse_subtitle_language[Movie.Title.pt.BR.srt-None-expected_flags8] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 94%]
tests/test_utils.py::test_parse_subtitle_language[Movie.Title.pob.srt-por-expected_flags9] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 95%]
tests/test_utils.py::test_parse_subtitle_language[Movie.Title.BR.srt-None-expected_flags10] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 96%]
tests/test_utils.py::test_parse_subtitle_language[My.Show.S01E01.720p.BluRay.x264-GRP.cze.forced.srt-ces-expected_flags11] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 96%]
tests/test_utils.py::test_parse_subtitle_language[Show.S01.E01.FR.srt-fra-expected_flags12] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 97%]
tests/test_utils.py::test_parse_subtitle_language[Show Name S01E01 Espa\xf1ol SDH.srt-spa-expected_flags13] <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 98%]
tests/test_utils.py::test_scan_media_files_simple <- ../Gemini_Renamer/tests/test_utils.py PASSED [ 99%]
tests/test_utils.py::test_scan_media_files_recursive <- ../Gemini_Renamer/tests/test_utils.py PASSED [100%]
ERROR: Coverage failure: total of 53 is less than fail-under=85


=================================== FAILURES ===================================
_________________ test_perform_undo_created_dir_main_exception _________________

basic_undo_manager = <rename_app.undo_manager.UndoManager object at 0x10cc0f6f0>
tmp_path = PosixPath('/private/var/folders/97/y921hrhn0c5ghrgc16rylvpr0000gn/T/pytest-of-alexmunroe/pytest-303/test_perform_undo_created_dir_0')
mocker = <pytest_mock.plugin.MockerFixture object at 0x10cb5d300>
capsys = <_pytest.capture.CaptureFixture object at 0x10cc0f820>

    def test_perform_undo_created_dir_main_exception(basic_undo_manager, tmp_path, mocker, capsys):
        """Test the main undo loop's generic exception handler via created_dir status update failure."""
        # Covers lines 530-538
        if not basic_undo_manager.is_enabled: pytest.skip("Undo disabled")
        mock_logger = mocker.patch('rename_app.undo_manager.log')
        created_dir = tmp_path / "cd_outer_exc"
        # Log the action, but DO NOT create the directory
        basic_undo_manager.log_action("batch_cd_outer", str(created_dir), str(created_dir), 'dir', 'created_dir')
        assert not created_dir.exists()
    
        # Mock update_action_status to raise an unexpected error *only* for this specific call
        error_msg = "Unexpected status update error for non-existent dir"
        original_update = basic_undo_manager.update_action_status
        def update_side_effect(batch_id, path, status):
            if batch_id == "batch_cd_outer" and path == str(created_dir) and status == 'reverted':
                raise ValueError(error_msg)
            # Allow other calls (if any) to proceed normally
            return original_update(batch_id, path, status)
    
        mocker.patch.object(basic_undo_manager, 'update_action_status', side_effect=update_side_effect)
        mocker.patch("builtins.input", return_value="y")
    
        result = basic_undo_manager.perform_undo("batch_cd_outer")
    
        assert result is False # Failed due to the exception during update
        assert not created_dir.exists() # Dir still shouldn't exist
    
        # Check the generic exception log for the action processing
        mock_logger.exception.assert_called_once()
        log_call_args = mock_logger.exception.call_args[0][0]
        # FIX: Check for the correct prefix and message content
        assert "[Undo ID 1] Unexpected error processing action" in log_call_args
>       assert error_msg in log_call_args
E       AssertionError: assert 'Unexpected status update error for non-existent dir' in '[Undo ID 1] Unexpected error processing action'

tests/test_undo_manager.py:261: AssertionError
----------------------------- Captured stdout call -----------------------------
--- Starting UNDO for batch 'batch_cd_outer' ---
Operations to be reverted (new -> original):
  [1] created_dir: Remove directory '/private/var/folders/97/y921hrhn0c5ghrgc16rylvpr0000gn/T/pytest-of-alexmunroe/pytest-303/test_perform_undo_created_dir_0/cd_outer_exc'
--- Performing Revert ---
  Skipped removal: Directory '/private/var/folders/97/y921hrhn0c5ghrgc16rylvpr0000gn/T/pytest-of-alexmunroe/pytest-303/test_perform_undo_created_dir_0/cd_outer_exc' does not exist.
  Unexpected error processing action ID 1 (created_dir for /private/var/folders/97/y921hrhn0c5ghrgc16rylvpr0000gn/T/pytest-of-alexmunroe/pytest-303/test_perform_undo_created_dir_0/cd_outer_exc): Unexpected status update error for non-existent dir
--- UNDO Complete for batch 'batch_cd_outer' ---
Summary: 0 succeeded, 1 failed, 0 skipped.
================================ tests coverage ================================
_______________ coverage: platform darwin, python 3.13.3-final-0 _______________

Name                             Stmts   Miss Branch BrPart  Cover   Missing
----------------------------------------------------------------------------
rename_app/api_clients.py           42     42     10      0     0%   1-60
rename_app/config_manager.py        94     94     34      0     0%   1-129
rename_app/file_system_ops.py      175     37    114     28    73%   15, 32->exit, 35->exit, 38, 54-67, 68->72, 69->72, 92->95, 112, 118->116, 128->126, 129->126, 137->135, 139->135, 145->216, 151->164, 152->148, 161, 165-166, 173->177, 175->173, 180->171, 184, 189-191, 192->195, 193->195, 198-213
rename_app/log_setup.py             30     30      4      0     0%   1-36
rename_app/main_processor.py       186    186     88      0     0%   3-289
rename_app/metadata_fetcher.py     207    207     60      0     0%   3-279
rename_app/models.py                43      1      0      0    98%   52
rename_app/renamer_engine.py       141     15     50      9    85%   19, 31-33, 39-40, 57->60, 61->68, 78, 82->exit, 87->exit, 90->exit, 92, 126-128, 138-139, 146->exit, 185->exit, 193-195
rename_app/undo_manager.py         377     35     86     11    90%   62-63, 101, 122-123, 147, 175, 227-228, 281-284, 310, 418-421, 425-428, 430-433, 474-475, 479-482, 530-532
rename_app/utils.py                172     30    100     18    78%   13, 18, 20, 22, 58->exit, 82, 88, 108->106, 111, 115, 120->exit, 125-131, 135->exit, 138->150, 144, 149, 159->166, 161->159, 165, 167, 171-176, 188->196, 193->195, 194->195, 198-200, 210, 215, 216->212, 220->219, 225->228
----------------------------------------------------------------------------
TOTAL                             1527    677    546     66    53%

3 files skipped due to complete coverage.
FAIL Required test coverage of 85.0% not reached. Total coverage: 53.26%
=========================== short test summary info ============================
FAILED tests/test_undo_manager.py::test_perform_undo_created_dir_main_exception - AssertionError: assert 'Unexpected status update error for non-existent dir' in '[Undo ID 1] Unexpected error processing action'
======================== 1 failed, 129 passed in 2.70s =========================
